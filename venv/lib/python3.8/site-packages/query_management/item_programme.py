import json
from query_management.query_fields.providerID import generate_providerID
from query_management.query_fields.title import generate_title
from query_management.query_fields.director import generate_director
from query_management.query_fields.year import generate_year


def generate_query(metadata):
    """
    Generate ElasticSearch query in JSON format

    Usage:
        >>> from query_management import item_programme
        >>> item_programme.generate_query(metadata)

    Params:
        - metadata: {
            query_providerID: string,
            query_title: string,
            query_director: string,
            query_year: string
        }

    Return: Query Object (in JSON format)
    """

    query_providerID = metadata.get("query_providerID")
    query_title = metadata.get("query_title")
    query_director = metadata.get("query_director")
    query_year = metadata.get("query_year")

    json_provider_query = {
        "query": {
            "nested": {
                "path": "providerData",
                "query": {}
            }
        }
    }

    json_metadata_query = {
        "query": {
            "nested": {
                "path": "providerData",
                "score_mode": "max",
                "query": {
                    "bool": {
                        "should": []
                    }
                },
            },
        },
    }

    json_output_query = ""

    if query_providerID:
        provider_query = generate_providerID(query_providerID)
        json_provider_query["query"]["nested"]["query"] = provider_query
        json_output_query += "{}\n" + json.dumps(json_provider_query) + "\n"

    if query_title:
        dismax_title = generate_title(query_title)
        json_metadata_query["query"]["nested"]["query"]["bool"]["should"].append(dismax_title)

    if query_director:
        dismax_director = generate_director(query_director)
        json_metadata_query["query"]["nested"]["query"]["bool"]["should"].append(dismax_director)

    if query_year:
        dismax_year = generate_year(query_year)
        json_metadata_query["query"]["nested"]["query"]["bool"]["should"].append(dismax_year)

    if query_title or query_director or query_year:
        json_output_query += "{}\n" + json.dumps(json_metadata_query)

    return json_output_query
